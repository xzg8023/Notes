####安卓动态获取权限问题


 
    第一次启动app时，使用系统提示申请相关的权限信息，可单独申请，也可成组的申请权限，用户可允许或者禁止权限；
    【此处已打电话的权限为例】然后在app中，打电话之前判断app是否已获取相关权限，如果没有则弹出相关的提示信息，让用户手动开启改权限，否则不能使用相关功能.
 >  **注：**应为安卓手机系统不同，导致使用系统获取权限的弹出框会在部分机型不支持【例小米】，所以统一弹出到该应用的应用信息界面，会有【权限】设置条目（安卓5.0以上版本）；


##### 1.权限的工具类
```java
<pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Consolas';font-size:13.5pt;">

import android.Manifest;
import android.app.Activity;
import android.content.Context;
import android.content.pm.PackageManager;
import android.os.Build;
import android.support.v4.app.ActivityCompat;
import android.support.v4.content.ContextCompat;
import android.text.TextUtils;
import android.util.Log;
import android.widget.Toast;

import java.util.ArrayList;

/**
 * Created by branch on 2016-7-24. */
 public class PermissionUtil {

  public static final int REQUESTCODE = 110;

  /**
 * 一组权限
  */
  public static boolean checkPermission(int[] grantResults) {
    if (grantResults == null) {
      return false;
  }

    for (int i = 0; i < grantResults.length; i++) {
      if (grantResults[i] != PackageManager.PERMISSION_GRANTED) {
        return false;
  }
    }

    return true;
  }

  public static boolean hasPhoneStatePermission(Context mContext) {
    return checkHasPermission(mContext, Manifest.permission.READ_PHONE_STATE);
  }

  public static boolean hasLocationPermission(Context mContext) {
    return checkHasPermission(mContext, Manifest.permission.ACCESS_FINE_LOCATION);
  }

  public static boolean hasExternalPermission(Context mContext) {
    return checkHasPermission(mContext, Manifest.permission.READ_EXTERNAL_STORAGE);
  }

  public static boolean hasCameraPermission(Context mContext) {
    return checkHasPermission(mContext, Manifest.permission.CAMERA);
  }
  public static boolean hasCallPermission(Context mContext) {
    return checkHasPermission(mContext, Manifest.permission.CALL_PHONE);
  }

  /**
 * @return true 已经有相应的权限，不用弹窗 false 没有权限会弹窗
  */
  public static boolean requestPhoneStatePermission(Activity activity, int requestCode) {
    if (!hasPhoneStatePermission(activity)) {
      openPermissionDialog(activity, requestCode, Manifest.permission.READ_PHONE_STATE);

 return false;  }
    return true;
  }

  /**
 * @return true 已经有相应的权限，不用弹窗 false 没有权限会弹窗
  */
  public static boolean requestExternalPermission(Activity activity, int requestCode) {
    if (!hasExternalPermission(activity)) {
      openPermissionDialog(activity, requestCode, Manifest.permission.WRITE_EXTERNAL_STORAGE);

 return false;  }
    return true;
  }

  /**
 * @return true 已经有相应的权限，不用弹窗 false 没有权限会弹窗
  */
  public static boolean requestLocationPermission(Activity activity, int requestCode) {

    if (!hasLocationPermission(activity)) {
      openPermissionDialog(activity, requestCode, Manifest.permission.ACCESS_FINE_LOCATION);

 return false;  }
    return true;
  }

  /**
 * @return true 已经有相应的权限，不用弹窗 false 没有权限会弹窗
  */
  public static boolean requestCameraPermission(Activity activity, int requestCode) {
    if (!hasCameraPermission(activity)) {
      openPermissionDialog(activity, requestCode, Manifest.permission.CAMERA);
 return false;  }

    return true;
  }

  public static boolean checkHasPermission(Context mContext, String permission) {

    if (Build.VERSION.SDK_INT < Build.VERSION_CODES.M) {
      return true;
  }

    boolean[] grantends = checkHasPermission(mContext, new String[]{permission});
 if (grantends == null || grantends.length == 0) {
      return false;
  }
    return grantends[0];
  }

  public static boolean[] checkHasPermission(Context mContext, String... permissions) {
    if (permissions == null || permissions.length == 0) {
      return null;
  }
    boolean[] result = new boolean[permissions.length];
 if (mContext == null) {
      return result;
  }
    for (int i = 0; i < permissions.length; i++) {
      if (!TextUtils.isEmpty(permissions[i]) && ContextCompat.checkSelfPermission(mContext, permissions[i]) == PackageManager.PERMISSION_GRANTED) {
        result[i] = true;
  } else {
        result[i] = false;
  }
    }

    return result;
  }

  public static void openPermissionDialog(Activity activity, int requestCode, String permission) {
    if (activity == null || TextUtils.isEmpty(permission)) {

      return;
  }
    //没有相应的权限
  if (!requestPermission(activity, requestCode, new String[]{permission})) {

    }
  }

  public static boolean requestPermission(Activity activity, int requestCode, String... permissions) {

    if (Build.VERSION.SDK_INT < Build.VERSION_CODES.M) {
      return false;
  }

    if (activity == null || permissions == null || permissions.length == 0) {
      return false;
  }

    ArrayList<String> shouldList = new ArrayList<String>(permissions.length);

 for (String p : permissions) {

      boolean should = ActivityCompat.shouldShowRequestPermissionRationale(activity, p);
  Log.e("branch", "requestPermission->" + should + " | " + p);
 if (should) {
        //是否需要给用户一个解释,当弹窗被拒绝后，should会变成true

  Toast.makeText(activity, "被拒绝后给用户一个解释", Toast.LENGTH_SHORT).show();

  } else {
        shouldList.add(p);
  }
    }

    if (!shouldList.isEmpty()) {

      String[] ps = new String[shouldList.size()];

  shouldList.toArray(ps);

  ActivityCompat.requestPermissions(activity, ps, requestCode);
 return true;  }

    return false;
  }

}
</pre>
```

#### 2.相关弹出框
```java
<pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Consolas';font-size:13.5pt;">/**
 * 权限相关的弹出框
  * Created by xzg on 2016/11/10.
 */public class PermissionDialog {

    /**
 * 提示用户没有相关的手机权限
  * @param mContext
  * @param msg
  * @param iPermissionDialog
  */
  public  static void showPermissionInfo(Context mContext,String msg, IPermissionDialog iPermissionDialog){
        showDialog(mContext,2,mContext.getString( R.string.permission_set ),mContext.getString( R.string.sf_text_dialog_exit_cancel_btn ),
  mContext.getString( R.string.permission_title ),msg,iPermissionDialog);

  }

    /**
 * 用户没有权限查看附件
  * @param mContext
  * @param iPermissionDialog
  */
  public static void showNoPermissionRead(Context mContext,IPermissionDialog iPermissionDialog){

        showDialog(mContext,1, mContext.getString( R.string.sf_text_dialog_exit_sure_btn ),mContext.getString( R.string.sf_text_dialog_exit_cancel_btn ),
  "",mContext.getString( R.string.permission_no_permission ), iPermissionDialog);
  }

    /**
 * 加解密SDK初始化失败提示信息
  * @param mContext
  * @param iPermissionDialog
  */
  public static void showSDKInitFail(Context mContext,IPermissionDialog iPermissionDialog){
        showDialog(mContext,1, mContext.getString( R.string.sf_text_dialog_exit_sure_btn ),mContext.getString( R.string.sf_text_dialog_exit_cancel_btn ),
  "",mContext.getString( R.string.dlda_dialog_wps_fail ), iPermissionDialog);
  }
    /**
 * 弹出对应的提示信息，只有一个按钮
  * @param mContext
  * @param msg 提示信息
  * @param iPermissionDialog 处理sureOnClick即可
  */
  public static void showPermissionDialog(Context mContext,String msg,IPermissionDialog iPermissionDialog){
        showDialog(mContext,1, mContext.getString( R.string.sf_text_dialog_exit_sure_btn ),mContext.getString( R.string.sf_text_dialog_exit_cancel_btn ),
  "",msg, iPermissionDialog);
  }
    /**
 * 弹出没有对应权限提示框对应
  * 的提示框
  * @param mContext
  * @param theme
  * @param btSure
  * @param btCancle
  * @param title
  * @param msg
  * @param iPermissionDialog
  */
  public static void showDialog(Context mContext,int theme, String btSure,String btCancle,
  String title, String msg, final IPermissionDialog iPermissionDialog) {

        final ExitDialog dialog = new ExitDialog( mContext, theme );
 if (!TextUtils.isEmpty( title )) {
            dialog.setTitleVisible( true );
  dialog.setTitleText( title );
  dialog.setTitleTextSize( 16 );
  dialog.setContentTextSize( 14 );
  }else {
            dialog.setTitleVisible( false );
  dialog.setContentTextSize( 16 );
  }

        dialog.setContentText( msg );
  dialog.setSureBtnText(btSure);
  dialog.setCancelBtnText(btCancle );
  dialog.setCancelable( false );
  dialog.setCanceledOnTouchOutside( false );

  dialog.setSureBtnClicklistener( new ExitDialog.BtnOnclick() {

            @Override
  public void btnClick(View view) {

                dismissDialog( dialog );
  iPermissionDialog.sureOnClick();

  }
        } );
  dialog.setCancelBtnClicklistener( new ExitDialog.BtnOnclick() {
            @Override
  public void btnClick(View view) {
                dismissDialog( dialog );
  iPermissionDialog.cancleOnClick();

  }
        } );

  showDialog( dialog );

  }

    private static void dismissDialog(ExitDialog dialog) {
        if (dialog != null && dialog.isShowing())
            dialog.dismiss();
  }

    private static void showDialog(ExitDialog dialog) {
        if (dialog != null && !dialog.isShowing()) {
            dialog.show();
  }
    }
}
</pre>
```

#### 3.权限动态申请相关
```java
<pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Consolas';font-size:13.5pt;">
@Override
protected void onCreate(Bundle savedInstanceState) {
   super.onCreate(savedInstanceState);
  setContentView(R.layout.activity_main);
  mContext =this;
 if (Build.VERSION.SDK_INT >= 23) {
      if (ContextCompat.checkSelfPermission(this,
  Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
         // 申请WRITE_EXTERNAL_STORAGE,CALL_PHONE权限
  ActivityCompat.requestPermissions(this, new String[]{
                     Manifest.permission.WRITE_EXTERNAL_STORAGE,
  Manifest.permission.CALL_PHONE,Manifest.permission.READ_PHONE_STATE
  },
  WRITE_EXTERNAL_STORAGE_REQUEST_CODE);
 return;  }
   }
   initView();

}

@SuppressLint("Override")
@Override
public void onRequestPermissionsResult(int requestCode,
  String[] permissions, int[] grantResults) {
   super.onRequestPermissionsResult(requestCode, permissions, grantResults);
  doPermissionNext(requestCode, grantResults);
}

private void doPermissionNext(int requestCode, int[] grantResults) {
   if (requestCode == WRITE_EXTERNAL_STORAGE_REQUEST_CODE) {
      if (grantResults[0] == PackageManager.PERMISSION_GRANTED) {
         initView();
  } else {
         finish();
  }
   }
}</pre>
```

#### 4.权限手动申请开启相关
```java
<pre style="background-color:#2b2b2b;color:#a9b7c6;font-family:'Consolas';font-size:13.5pt;">{//a.权限问题,提示开启相关权限
  IPermissionDialog iPermissionDialog = new IPermissionDialog() {
        @Override
  public void cancleOnClick() {
            iOpenFileWithWps.cancleReadPhoneOnClick();
  }

        @Override
  public void sureOnClick() {
            Intent intent = new Intent();
  intent.setAction( Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
  intent.setData( Uri.fromParts("package", mContext.getPackageName(), null));
  mContext.startActivity(intent);
  iOpenFileWithWps.sureReadPhoneOnClick();
  }
    };
  PermissionDialog.showPermissionInfo(mContext, mContext.getString( R.string.permission_read_phone_state ),iPermissionDialog);
  }</pre>
```
